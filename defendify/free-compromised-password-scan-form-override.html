<script>
    (function ($) {

        console.log('Hubspot Form integration: Free Compromised Password Scan');

        const formId = '#wp-free-compromised-password-form';
        const baseUrl = window.location.origin;
        const ajaxscript = `${baseUrl}/wp-admin/admin-ajax.php`;

        // Add an ID on the form for Hubspot integration
        $('.free-compromised-password-form .jet-form').attr('id', 'wp-free-compromised-password-form');
        $(`${formId} .field-type-submit .submit-type-reload`).hide();
        $(`${formId} .field-type-submit .jet-form__submit-wrap`).append('<button class="verify-email">Verify Email</button>');

        // Fetch validation messages
        $.ajax({
            url: ajaxscript,
            data: {
                action: "defendify_form_validations_ajax_controller",
                "option-page": "form-validations",
                form: "contact-us-form"
            },
            success: function (data) {
                const messages = JSON.parse(data);
                $(`${formId} .firstname-field`).attr('validation-message', messages.firstname_field);
                $(`${formId} .lastname-field`).attr('validation-message', messages.lastname_field);
                $(`${formId} .email-field`).attr('validation-message', messages.email_field);
                $(`${formId} .field-type-submit`).attr('validation-message', messages.submit_failed);
            }
        });

        $(document).on('click', `${formId} .field-type-submit .jet-form__submit-wrap .verify-email`, function (event) {
            event.preventDefault();
            handleEmailValidation();
        });

        $(`${formId} .email-field #email`).on('input', function () {
            $(`${formId} .field-type-submit .submit-type-reload`).hide();
            $(`${formId} .field-type-submit .jet-form__submit-wrap .verify-email`).show();
        });

        $(document).on('submit', formId, function (event) {
            event.preventDefault();
            handleFormValidation();
        });

        function handleEmailValidation() {
            console.log("handleEmailValidation: " + email);
            const email = $(`${formId} .email-field input`).val();
            console.log("email:" + email );
            const validations = free_compromised_password_scan_form_check_validation_messages();

            $(`${formId} .jet-form-col.email-field .notif`).remove();
            $(`${formId} .jet-form-col.email-field .notif-success`).remove();
            $(`${formId} .jet-form-col.email-field`).append('<span class="notif">Please wait as we check your email for verification...</span>');

            if (isEmailValid(email)) {
                console.log("isEmailValid TRUE");
                scan_api_call();
            } else {
                console.log("isEmailValid FALSE");
                $(`${formId} .jet-form-col.email-field .notif`).remove();
                $(`${formId} .jet-form-col.email-field .notif-error`).remove();
                $(`${formId} .jet-form-col.email-field`).append(notifError(validations['email-message']));
            }
        }

        function handleFormValidation() {
            console.log('Handling wp-free-compromised-password-form validation');
            const validations = free_compromised_password_scan_form_check_validation_messages();
            handleValidationFeedback(validations);
        }

        function handleValidationFeedback(validations) {
            if (validations['status'] === false) {
                showErrorMessages(validations);
            } else {
                elementorProFrontend.modules.popup.showPopup({ id: 1278 });
                const redirect_url = $(`${formId} .field-type-submit`).attr('scan-result');
                window.location.replace(redirect_url);
            }
        }

        function showErrorMessages(validations) {
            // Handle the error display logic here...
        }

        function free_compromised_password_scan_form_check_validation_messages(messages) {
            // Handle the validation logic here...
        }

        function onlyLettersAndSpaces(str) {
            return /^[a-zA-Z]+[- ']{0,1}[a-zA-Z]+$/.test(str);
        }

        function onlyNumbers(str) {
            return /^[0-9]+$/.test(str);
        }

        function validateEmail(email) {
            const emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
            return emailReg.test(email);
        }

        function notifSuccess(str) {
            return `<div class='notif-success'><img class='icon' src='${base_url}/wp-content/uploads/2022/09/Icon.svg' width='56' height='56'><span class='message'>${str}</span></div>`;
        }

        function notifError(str) {
            return `<span class="notif-error">${str}</span>`;
        }

        function isEmailValid(email) {
            // Handle email validation logic here...
        }

        function scan_api_call() {
            // Handle the API call logic here...
        }
    })(jQuery);
</script>